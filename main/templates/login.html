{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Login - Turboa</title>
{% endblock meta %}

{% block content %}
<div class="w-full min-h-screen relative bg-cover bg-center flex items-center justify-end pr-25 sm:pr-32"
  style="background-image: url('{% static 'image/Background.png' %}')">
  <div class="bg-white rounded-lg p-8 w-full max-w-md">
    <div class="text-center mb-6">
      <h1 class="text-3xl sm:text-4xl font-bold text-[#134686] mb-2">Sign In</h1>
      <p class="text-lg text-gray-600">Welcome back to Turboa</p>
    </div>

    <!-- Tempat untuk menampilkan error AJAX -->
    <div id="ajaxErrors" class="mb-6"></div>

    <!-- Login Form -->
    <form id="loginForm" method="POST" class="mt-3 space-y-6">
      {% csrf_token %}

      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
        <input id="username" name="username" type="text" required
          class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-[#134686] transition-colors"
          placeholder="Enter your username">
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
        <input id="password" name="password" type="password" required
          class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-[#134686] transition-colors"
          placeholder="Enter your password">
      </div>

      <button type="submit" id="loginButton"
        class="w-full font-medium py-3 px-4 rounded-md hover:opacity-90 transition-colors"
        style="background-color: #134686; color: white;">
        Sign In
      </button>
    </form>

    <div class="mt-6 text-center pt-6 border-t border-gray-200">
      <p class="text-gray-500 text-sm">
        Don't have an account?
        <a href="{% url 'main:register' %}" class="text-[#ED3F27] hover:text-[#ED3F27] font-medium">
          Register Now
        </a>
      </p>
    </div>
  </div>
</div>
{% endblock content %}

<script>
  const loginForm = document.getElementById('loginForm');
  const loginButton = document.getElementById('loginButton');
  const ajaxErrors = document.getElementById('ajaxErrors');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();  // cegah reload halaman
    ajaxErrors.innerHTML = '';  // reset error messages

    loginButton.disabled = true;
    loginButton.textContent = 'Signing In...';

    const formData = new FormData(loginForm);

    try {
      const response = await fetch("{% url 'main:user_login_ajax' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData,
        credentials: 'same-origin'
      });

      const data = await response.json();

      if (response.ok && data.success) {
        window.location.href = data.redirect_url;
      } else {
        if (data.errors) {
          for (const field in data.errors) {
            data.errors[field].forEach(err => {
              const div = document.createElement('div');
              div.className = 'px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
              div.textContent = `${field}: ${err.message}`;
              ajaxErrors.appendChild(div);
            });
          }
        } else if (data.error) {
          const div = document.createElement('div');
          div.className = 'px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
          div.textContent = data.error;
          ajaxErrors.appendChild(div);
        }
      }
    } catch (err) {
      const div = document.createElement('div');
      div.className = 'px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
      div.textContent = 'Something went wrong, please try again.';
      ajaxErrors.appendChild(div);
    } finally {
      loginButton.disabled = false;
      loginButton.textContent = 'Sign In';
    }
  });
</script>